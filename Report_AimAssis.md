# Aim Assist System 系統報告

## 系統概述

這是一個基於 YOLOv11n 的 2D 遊戲輔助瞄準系統，專為 ZombsRoyale.io 設計，用於研究與教學用途。

## 核心模組

| 模組 | 檔案 | 功能 |
|------|------|------|
| 螢幕擷取 | `core/capture.py` | 擷取 1920×1080 畫面，縮放至 640×360 |
| 目標偵測 | `core/detector.py` | YOLOv11n 推論，輸出 Detection 物件 |
| 目標選擇 | `core/target_selector.py` | 選擇最近目標，過濾自己玩家 |
| 控制器 | `core/controller.py` | PD 控制 + α-β 平滑演算法 |
| 滑鼠控制 | `core/mouse_control.py` | 執行相對滑鼠移動 |
| 透明疊層 | `overlay/hud.py` | PyQt5 顯示偵測框與資訊 |

## 系統流程圖

```
┌─────────────────────────────────────────────────────────────────┐
│                         主迴圈 (main.py)                         │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. 螢幕擷取 (ScreenCapture)                                     │
│     ┌───────────────┐      ┌───────────────┐                    │
│     │ 擷取 1920×1080 │  →   │ 縮放 640×360  │  → BGR numpy array │
│     └───────────────┘      └───────────────┘                    │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. 目標偵測 (EnemyDetector)                                     │
│     ┌───────────────┐      ┌───────────────┐                    │
│     │ YOLOv11n 推論  │  →   │ List[Detection]│ (模型座標)        │
│     │ confidence>0.1│      │ x1,y1,x2,y2   │                    │
│     └───────────────┘      └───────────────┘                    │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. 座標轉換                                                     │
│     模型座標 (640×360) × 3 = 螢幕座標 (1920×1080)                 │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. 目標選擇 (TargetSelector)                                    │
│     ┌─────────────────────────────────────────────────────────┐ │
│     │ 過濾自己玩家：排除包含螢幕中心 (960,540) 的偵測框          │ │
│     └─────────────────────────────────────────────────────────┘ │
│                              │                                   │
│                              ▼                                   │
│     ┌─────────────────────────────────────────────────────────┐ │
│     │ 計算距離：各偵測框中心 vs 滑鼠位置                         │ │
│     └─────────────────────────────────────────────────────────┘ │
│                              │                                   │
│                              ▼                                   │
│     ┌─────────────────────────────────────────────────────────┐ │
│     │ 選擇距離最近的目標                                        │ │
│     └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. 控制器運算 (AimController)                                   │
│     ┌───────────────┐      ┌───────────────┐      ┌───────────┐ │
│     │ 計算誤差      │  →   │ PD 控制器     │  →   │ α-β 平滑  │ │
│     │ error = 目標  │      │ output = Kp*e │      │ 限制最大  │ │
│     │       - 滑鼠  │      │       + Kd*Δe │      │ 速度      │ │
│     └───────────────┘      └───────────────┘      └───────────┘ │
│                                                        │        │
│                                                        ▼        │
│                                              輸出 (dx, dy)      │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. 滑鼠移動 (MouseController)                                   │
│     ┌───────────────┐                                           │
│     │ pynput 執行   │  → 系統滑鼠相對移動                        │
│     │ move_relative │                                           │
│     └───────────────┘                                           │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│  7. Overlay 更新 (OverlayManager)                                │
│     顯示：偵測框、FPS、延遲、Aim Assist 狀態                      │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 └──────────────→ 回到步驟 1
```

## 關鍵參數設定

### 控制器參數 (config.yaml)

| 參數 | 值 | 說明 |
|------|-----|------|
| kp | 0.25 | 比例係數 (越高追蹤越快) |
| kd | 0.08 | 微分係數 (抑制震盪) |
| alpha | 0.7 | 平滑係數 (越低反應越即時) |
| dead_zone | 3 px | 死區半徑 |
| max_speed | 50 px/幀 | 最大移動速度 |

### 偵測參數

| 參數 | 值 | 說明 |
|------|-----|------|
| confidence_threshold | 0.1 | 信心閾值 |
| device | cuda | GPU 加速 |
| model | YOLOv11n | 輕量化模型 |

## 特殊處理邏輯

### 自己玩家過濾機制

由於模型會偵測到所有角色（包含自己的玩家），系統實作了過濾邏輯：

```
螢幕中心 (960, 540) = 玩家位置

對於每個偵測框：
    如果 偵測框包含螢幕中心：
        排除此偵測框（可能是自己）
    否則：
        加入候選目標
```

此邏輯位於 `core/target_selector.py` 第 41-53 行。

## 效能指標

| 指標 | 數值 |
|------|------|
| 模型推論 | ~3 ms |
| 端到端延遲 | <30 ms |
| 系統 FPS | >30 FPS |

## 操作方式

| 按鍵 | 功能 |
|------|------|
| T | 切換 Aim Assist 開關 |
| ESC | 退出程式 |

## 專案結構

```
AimAssistSystem/
├── main.py              # 主程式入口
├── config.yaml          # 設定檔
├── requirements.txt     # Python 依賴
├── SPEC.md              # 系統規格文件
├── Report.md            # 本報告
│
├── core/                # 核心模組
│   ├── __init__.py      # Lazy imports
│   ├── capture.py       # 螢幕擷取
│   ├── detector.py      # YOLO 推論
│   ├── target_selector.py  # 目標選擇
│   ├── controller.py    # PD 控制器
│   └── mouse_control.py # 滑鼠控制
│
├── overlay/             # UI 模組
│   ├── __init__.py      # Lazy imports
│   └── hud.py           # 透明 Overlay
│
├── utils/               # 工具模組
│   ├── coordinate.py    # 座標轉換
│   └── logger.py        # 日誌記錄
│
└── logs/                # 日誌輸出
```

## 依賴套件

- **Deep Learning**: ultralytics, torch, torchvision
- **Image Processing**: opencv-python-headless, numpy
- **Screen Capture**: mss
- **Mouse Control**: pyautogui, pynput
- **GUI**: PyQt5
- **Configuration**: pyyaml
- **Logging**: pandas

## 系統需求

- **作業系統**: Linux (需要 X11 顯示環境)
- **Python**: 3.8+
- **GPU**: NVIDIA GPU (支援 CUDA)
- **螢幕解析度**: 1920×1080
