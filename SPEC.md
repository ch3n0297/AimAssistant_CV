# 2D 遊戲 Aim Assist 系統規格文件

版本：v2.0
角色：主管／專案負責人 → 系統工程師之規格與需求文件
適用範圍：本文件規範「2D 網頁遊戲即時 Aim Assist 系統」之整體架構、功能與介面，不含模型訓練細節（模型訓練另有專屬規範）。

---

## Changelog

### v2.0 (2025-12-10)
- 架構改為單體式 Python 桌面應用程式
- 目標遊戲改為外部開源遊戲 ZombsRoyale.io
- 允許 OS 滑鼠控制（僅限研究用途）
- 移除前端 ONNX 推論方案
- 螢幕擷取解析度改為 1920×1080 → 640×360
- 簡化鍵盤控制（僅 T 切換、ESC 退出）
- 新增透明 Overlay 視窗顯示偵測框

---

## 1. 系統目標與範圍

### 1.1 系統目標

**S-1.1.1** 系統必須提供一個針對 2D 網頁遊戲之「輔助瞄準（Aim Assist）」功能，透過已訓練完成之 YOLOv11n 模型，即時偵測遊戲畫面中的敵人，並透過控制系統滑鼠使準星朝目標平滑移動。

**S-1.1.2** 系統的輔助瞄準僅限於「展示與研究用途」，主要用於：

* 展示電腦視覺在互動系統中的應用
* 評估「命中率、取靶時間」等量化指標
* 研究 PD 控制器與平滑演算法在即時系統中的表現

**S-1.1.3** 系統允許控制作業系統滑鼠游標，但僅限於對開源遊戲 ZombsRoyale.io 進行研究與展示。本系統不得用於任何商業遊戲或違反遊戲服務條款之場景。

### 1.2 範圍說明

**S-1.2.1** 本文件規範以下模組之行為與介面：

* 螢幕擷取模組（Screen Capture）
* 推論模組（本地 PyTorch 推論）
* 目標選擇模組
* 控制器模組（PD / α–β 平滑）
* Overlay HUD 顯示模組
* 滑鼠控制模組
* 設定與參數管理模組
* 日誌與效能監控模組

**S-1.2.2** 模型本身（YOLO 權重與訓練過程）由「模型訓練規範」文件單獨管理，此處僅約定其輸入／輸出介面。

**S-1.2.3** 目標遊戲為 ZombsRoyale.io（https://zombsroyale.io），一款 2D 俯視角大逃殺遊戲，使用滑鼠位置控制瞄準方向。

---

## 2. 系統架構總覽

### 2.1 高階架構

**S-2.1.1** 系統為單體式 Python 桌面應用程式，整體資料流如下：

1. 遊戲 ZombsRoyale.io 在瀏覽器中全螢幕運行（1920×1080）。
2. 螢幕擷取模組以固定時間間隔擷取全螢幕畫面，縮放至 640×360。
3. 擷取的影像送入本地 YOLO 推論模組，產生敵人偵測框及信心分數。
4. 目標選擇模組依據偵測結果自動選擇距離滑鼠最近的目標。
5. 控制器模組依據目標位置與目前滑鼠位置計算平滑移動向量。
6. 滑鼠控制模組執行相對移動，使滑鼠漸進貼近目標。
7. Overlay 視窗在螢幕上渲染偵測框、狀態指示（Aim Assist ON/OFF、FPS、延遲等）。
8. 日誌模組記錄偵測事件與系統效能，用於後續分析。

### 2.2 架構圖

```
┌────────────────────────────────────────────────────────────────┐
│  Python 單體應用程式                                            │
│                                                                │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐       │
│  │ 螢幕擷取模組  │   │ 推論模組     │   │ 控制模組     │        │
│  │ mss 截圖     │──→│ YOLOv11n    │──→│ PD 控制器    │        │
│  │ 1920×1080   │   │ 目標選擇     │   │ 座標映射     │        │
│  │ → 640×360   │   │             │   │ 滑鼠移動     │        │
│  └──────────────┘   └──────────────┘   └──────────────┘       │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │ Overlay 視窗 (透明)                                       │ │
│  │ - 偵測框顯示                                              │ │
│  │ - 狀態資訊 (FPS, 延遲, ON/OFF)                            │ │
│  └──────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
```

### 2.3 技術選型

**S-2.3.1** 系統採用以下技術：

| 功能 | 技術選型 |
|------|---------|
| 螢幕擷取 | mss |
| 模型推論 | PyTorch + Ultralytics |
| 滑鼠控制 | pyautogui / pynput |
| Overlay 視窗 | PyQt5 |
| 設定管理 | YAML |

---

## 3. 功能需求規範

### 3.1 螢幕擷取模組

**S-3.1.1** 螢幕擷取模組固定擷取全螢幕畫面，解析度為 1920×1080。

**S-3.1.2** 擷取後需將畫面縮放至 YOLO 模型預期的輸入尺寸 640×360（16:9 比例），並以 RGB 格式輸出為 numpy array。

**S-3.1.3** 擷取頻率應盡可能高，目標為 30 FPS 或以上。

**S-3.1.4** 擷取過程應使用高效能函式庫（如 mss），避免成為系統瓶頸。

---

### 3.2 推論模組

**S-3.2.1** 推論模組載入已訓練的 YOLOv11n 模型（`best.pt`），使用 PyTorch 進行本地推論。

**S-3.2.2** 模型路徑：`/home/hjc/coSpace/CV_final/ModelTraining/models/enemy_detection_v11n/best.pt`

**S-3.2.3** 推論輸入為 640×360 RGB 影像，輸出為偵測結果列表，每個偵測結果至少包含：

* `x1, y1, x2, y2`：邊界框座標（相對於 640×360）
* `score`：信心分數
* `class_id`：類別 ID
* `center_x, center_y`：邊界框中心座標

**S-3.2.4** 推論時需過濾掉 `score < threshold` 的結果（閾值可配置，預設 0.5）。

**S-3.2.5** 系統應支援 CUDA 加速，若 GPU 不可用則回退至 CPU。

---

### 3.3 目標選擇模組

**S-3.3.1** 在每次取得偵測結果後，系統必須執行「目標選擇」邏輯，產出一個「目前鎖定目標」（或無目標）。

**S-3.3.2** 目標選擇規則：

1. 過濾掉 `score < threshold` 的偵測結果。
2. 若無任何合格框，則當前無鎖定目標。
3. 若有多個候選框，自動選擇「距離目前滑鼠位置最近」者作為鎖定目標。

**S-3.3.3** 目標選擇結果需在 Overlay 上清楚標示：鎖定目標之框與其他候選目標的框顏色需有明顯區別。

---

### 3.4 控制器模組（PD / α–β 平滑）

**S-3.4.1** 系統座標系統定義：

* 螢幕左上角為 (0, 0)，右下角為 (1920, 1080)。
* 滑鼠位置與敵人框中心均以此座標系表示。
* 偵測座標（640×360）需映射回螢幕座標（1920×1080）。

**S-3.4.2** 控制器輸入：

* 目前滑鼠位置 `(cx, cy)`
* 鎖定目標中心（映射後）`(tx, ty)`
* 兩者差值 `(ex, ey) = (tx - cx, ty - cy)`

**S-3.4.3** 必須實作 PD 控制器，計算平滑的移動向量，使滑鼠漸進貼近目標，而非瞬間跳躍。

**S-3.4.4** 系統需對控制輸出進行 α–β（或指數）平滑，以降低偵測抖動帶來的瞬時不穩定。

**S-3.4.5** 控制器需提供以下可配置參數：

| 參數 | 說明 | 預設值 |
|------|------|--------|
| `kp` | 比例係數 | 0.15 |
| `kd` | 微分係數 | 0.05 |
| `alpha` | 平滑係數 (0-1) | 0.85 |
| `dead_zone` | 死區半徑（像素） | 5 |
| `max_speed` | 最大移動速度（像素/幀） | 30 |

**S-3.4.6** 當目標與滑鼠距離小於死區時，不進行移動。

**S-3.4.7** Aim Assist 關閉時，控制器完全不影響滑鼠，玩家可完全手動控制。

---

### 3.5 滑鼠控制模組

**S-3.5.1** 滑鼠控制模組負責執行控制器計算出的移動向量。

**S-3.5.2** 必須使用相對移動（relative move）而非絕對移動，以保持平滑感。

**S-3.5.3** 滑鼠控制需能取得目前滑鼠位置，供控制器計算使用。

---

### 3.6 Overlay HUD 顯示

**S-3.6.1** 系統必須提供透明 Overlay 視窗，覆蓋在遊戲畫面上方，顯示以下視覺元素：

* 偵測框：所有分數 ≥ 閾值之敵人框（綠色）
* 鎖定目標框：加粗或採用不同顏色顯示（紅色）
* 系統狀態文字：Aim Assist ON/OFF、推論 FPS、平均延遲

**S-3.6.2** Overlay 視窗必須：

* 全螢幕覆蓋（1920×1080）
* 完全透明背景
* 允許滑鼠穿透（不攔截滑鼠事件）
* 始終置頂

**S-3.6.3** 使用者必須能透過鍵盤快捷鍵控制：

| 按鍵 | 功能 |
|------|------|
| `T` | 切換 Aim Assist 開關（ON / OFF） |
| `ESC` | 結束程式 |

---

### 3.7 設定與參數管理

**S-3.7.1** 系統需提供集中化設定檔（`config.yaml`），用於管理：

* 螢幕擷取設定（解析度、目標尺寸）
* 模型設定（路徑、閾值、裝置）
* 控制器參數（P/D、平滑係數、死區、速度上限）
* Overlay 顯示設定
* 日誌設定

**S-3.7.2** 設定檔格式為 YAML，範例如下：

```yaml
capture:
  screen_width: 1920
  screen_height: 1080
  target_size: [640, 360]

detection:
  model_path: "/path/to/best.pt"
  confidence_threshold: 0.5
  device: "cuda"

controller:
  kp: 0.15
  kd: 0.05
  alpha: 0.85
  dead_zone: 5
  max_speed: 30

overlay:
  enabled: true
  show_all_boxes: true
  show_fps: true

logging:
  enabled: true
  output_dir: "./logs"
```

---

### 3.8 日誌與效能紀錄

**S-3.8.1** 系統必須提供以下事件紀錄能力：

* 每次偵測與推論的時間戳與耗時
* 每幀偵測到的目標數量
* Aim Assist 狀態（ON/OFF）
* 系統 FPS 與延遲

**S-3.8.2** 日誌格式建議為 CSV 或 JSON，欄位至少包括：

* `timestamp`
* `frame_id`
* `aim_assist_enabled`
* `detection_count`
* `inference_time_ms`
* `total_latency_ms`

**S-3.8.3** 日誌檔案需可供後續離線分析與報告使用。

---

## 4. 非功能需求

### 4.1 效能與即時性

**S-4.1.1** 系統應達成以下效能目標：

| 指標 | 理想值 | 可接受值 |
|------|--------|----------|
| 模型推論時間（640×360） | ≤ 20ms | ≤ 30ms |
| 整體系統 FPS | ≥ 30 FPS | ≥ 20 FPS |
| 端到端控制延遲 | ≤ 100ms | ≤ 150ms |

**S-4.1.2** 若實測未達上述目標，工程師需提出改善方案並提供對比結果。

### 4.2 穩定性與容錯

**S-4.2.1** 當推論模組發生錯誤時，系統必須：

* 保持程式正常運行
* 暫停 Aim Assist 功能
* 在 Overlay 上顯示錯誤狀態

**S-4.2.2** 系統不得因單次推論錯誤而造成程式崩潰。

---

### 4.3 使用體驗

**S-4.3.1** 玩家應能清楚感知 Aim Assist 正在運作，但不應產生令人不適的「瞬移」或極度抖動。

**S-4.3.2** Aim Assist 關閉時，滑鼠控制必須完全回到玩家手動操作，不應有殘留控制影響。

---

## 5. 安全、倫理與限制

**S-5.1.1** 系統僅限於對開源遊戲 ZombsRoyale.io 進行研究與展示，不得用於任何商業遊戲。

**S-5.1.2** 在所有公開展示、報告與文件中，必須明確標註：

* 本系統為研究／教學與技術展示用途
* 不鼓勵、不支援任何形式之實際遊戲作弊行為

**S-5.1.3** 本系統控制 OS 滑鼠僅限於研究目的，使用者需自行承擔使用責任。

---

## 6. 驗收與測試標準

### 6.1 功能驗收

**S-6.1.1** 功能驗收至少包含以下測試場景：

1. 無敵人場景：系統不應產生任何偵測框或錯誤鎖定。
2. 單一敵人場景：滑鼠應能在合理延遲內平滑貼近敵人中心。
3. 多敵人場景：系統應自動選擇最近的敵人。
4. Aim Assist 開／關：`T` 鍵切換狀態應立即生效，Overlay 顯示正確。

### 6.2 效能驗收

**S-6.2.1** 連續運行至少 10 分鐘，量測：

* 平均和 95% 分位數推論時間
* 系統 FPS 分佈
* 端到端延遲

結果須符合第 4.1 節中之效能目標。

---

## 7. 版本與變更管理

**S-7.1.1** 每次對系統架構或介面造成不相容變更時，必須更新本規格文件版本號並紀錄 Changelog。

**S-7.1.2** 本文件與「模型訓練規範」應視為同一專案技術基準文件，變更時須同步考量兩者的一致性。

---

> 本文件為對系統工程師之正式規格說明，用於約束實作方向與驗收標準。
> 實作過程中，如需偏離本規格，工程師必須先提出書面說明，經專案負責人同意後方可調整。
